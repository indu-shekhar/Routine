<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Routine & Mess Menu</title>
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Neue', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #a8e6cf 0%, #dcedc8 50%, #c8e6c9 100%);
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        /* Cute floating elements background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(120, 255, 120, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 180, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 200, 255, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 25px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.1), 0 0 0 1px rgba(255,255,255,0.5);
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(139, 195, 74, 0.2);
        }

        .header {
            background: linear-gradient(135deg, #4caf50 0%, #8bc34a 50%, #cddc39 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        /* Cute decorative elements in header */
        .header::before {
            content: 'üå± üåø üçÄ ‚ú® üå∏ ü¶ã üåº ‚òÄÔ∏è';
            position: absolute;
            top: 10px;
            left: 0;
            right: 0;
            font-size: 1.2em;
            opacity: 0.3;
            animation: float 6s ease-in-out infinite;
        }

        .header::after {
            content: 'üå∫ üåª üå∑ üåπ üçÉ üêù üåà ‚≠ê';
            position: absolute;
            bottom: 10px;
            left: 0;
            right: 0;
            font-size: 1.2em;
            opacity: 0.3;
            animation: float 6s ease-in-out infinite reverse;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        @keyframes sparkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        .header h1 {
            font-size: 2.8em;
            margin-bottom: 15px;
            font-weight: 600;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            position: relative;
            z-index: 2;
        }

        .datetime {
            font-size: 1.3em;
            opacity: 0.95;
            margin-bottom: 15px;
            background: rgba(255,255,255,0.15);
            padding: 8px 20px;
            border-radius: 25px;
            display: inline-block;
            border: 1px solid rgba(255,255,255,0.2);
            position: relative;
            z-index: 2;
        }

        .current-time {
            font-size: 1.2em;
            background: rgba(255,255,255,0.25);
            padding: 12px 24px;
            border-radius: 30px;
            display: inline-block;
            border: 2px solid rgba(255,255,255,0.3);
            animation: bounce 2s infinite;
            position: relative;
            z-index: 2;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .content {
            padding: 40px;
            background: linear-gradient(180deg, #f1f8e9 0%, #e8f5e8 100%);
        }

        .section {
            margin-bottom: 40px;
            background: linear-gradient(135deg, #ffffff 0%, #f9fff9 100%);
            border-radius: 20px;
            padding: 35px;
            border: 3px solid #a5d6a7;
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.15);
            position: relative;
            overflow: hidden;
        }

        /* Cute decorative corner elements */
        .section::before {
            content: 'üåø';
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 1.5em;
            opacity: 0.6;
            animation: sparkle 3s ease-in-out infinite;
        }

        .section h2 {
            color: #2e7d32;
            margin-bottom: 25px;
            font-size: 2em;
            display: flex;
            align-items: center;
            font-weight: 600;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .icon {
            margin-right: 15px;
            font-size: 1.3em;
            padding: 8px;
            background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%);
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
            height: 40px;
            animation: bounce 2s infinite;
        }

        .routine-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }

        .time-slot {
            background: linear-gradient(135deg, #ffffff 0%, #f1f8e9 100%);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.1);
            border: 2px solid #c8e6c9;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .time-slot::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #4caf50 0%, #8bc34a 100%);
        }

        .time-slot:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.2);
            border-color: #81c784;
        }

        .time-slot.current {
            border: 3px solid #ff6b6b;
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            animation: bounce 1.5s ease-in-out infinite;
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
        }

        .time-slot.current::before {
            background: linear-gradient(90deg, #ff6b6b 0%, #ff8a65 100%);
            height: 6px;
        }

        .time-slot h3 {
            font-size: 1.1em;
            margin-bottom: 10px;
            color: #2e7d32;
            font-weight: 600;
            display: flex;
            align-items: center;
        }

        .time-slot h3::before {
            content: '‚è∞';
            margin-right: 8px;
            font-size: 1.2em;
        }

        .time-slot.current h3 {
            color: #e65100;
        }

        .time-slot.current h3::before {
            content: 'üî•';
            animation: sparkle 1s ease-in-out infinite;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px;
            margin-top: 25px;
        }

        .meal-card {
            background: linear-gradient(135deg, #ffffff 0%, #f1f8e9 100%);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.1);
            border: 3px solid #c8e6c9;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .meal-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, #4caf50 0%, #8bc34a 50%, #cddc39 100%);
        }

        .meal-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(76, 175, 80, 0.2);
            border-color: #81c784;
        }

        .meal-card h3 {
            color: #2e7d32;
            margin-bottom: 20px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            font-weight: 600;
            padding-bottom: 10px;
            border-bottom: 2px dotted #c8e6c9;
        }

        .meal-items {
            line-height: 1.8;
            color: #388e3c;
            font-size: 1.05em;
            font-weight: 500;
        }

        .current-meal {
            border: 3px solid #ff6b6b;
            background: linear-gradient(135deg, #fff8e1 0%, #ffe0b2 100%);
            animation: bounce 2s ease-in-out infinite;
            box-shadow: 0 12px 30px rgba(255, 107, 107, 0.3);
        }

        .current-meal::before {
            background: linear-gradient(90deg, #ff6b6b 0%, #ff8a65 100%);
            height: 8px;
        }

        .current-meal h3 {
            color: #e65100;
        }

        .current-meal .meal-items {
            color: #bf360c;
        }

        .no-class {
            color: #81c784;
            font-style: italic;
            font-weight: 500;
            position: relative;
        }

        .no-class::before {
            content: 'üå∏ ';
            margin-right: 5px;
        }

        .error {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            color: #c62828;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border: 2px solid #e57373;
            box-shadow: 0 4px 15px rgba(198, 40, 40, 0.1);
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #388e3c;
            font-size: 1.2em;
            font-weight: 600;
        }

        .loading::before {
            content: 'üå± ';
            font-size: 2em;
            display: block;
            margin-bottom: 15px;
            animation: bounce 1s infinite;
        }

        /* Cute floating particles */
        .floating-element {
            position: fixed;
            pointer-events: none;
            z-index: 0;
            animation: floatUp 8s infinite linear;
        }

        @keyframes floatUp {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) rotate(360deg);
                opacity: 0;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .content {
                padding: 20px;
            }
            
            .section {
                padding: 20px;
            }
            
            .routine-grid {
                grid-template-columns: 1fr;
            }
            
            .menu-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Google Calendar Integration Styles */
        .calendar-sync-section {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }

        .google-btn {
            background: white;
            color: #444;
            border: 2px solid #ddd;
            padding: 12px 24px;
            border-radius: 30px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            font-family: 'Comic Neue', 'Segoe UI', sans-serif;
        }

        .google-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            border-color: #4285f4;
        }

        .google-btn:active {
            transform: translateY(0);
        }

        .google-btn.primary {
            background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
            color: white;
            border: none;
        }

        .google-btn.danger {
            background: #ea4335;
            color: white;
            border: none;
        }

        .google-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .sync-status {
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            display: inline-block;
        }

        .sync-status.success {
            background: rgba(76, 175, 80, 0.2);
            color: #2e7d32;
        }

        .sync-status.error {
            background: rgba(244, 67, 54, 0.2);
            color: #c62828;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #333;
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .checkbox-group {
            margin: 15px 0;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            padding: 10px;
            cursor: pointer;
            border-radius: 10px;
            transition: background 0.2s;
        }

        .checkbox-group label:hover {
            background: #f5f5f5;
        }

        .checkbox-group input[type="checkbox"] {
            margin-right: 10px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            font-size: 1em;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .modal-btn.primary {
            background: #4285f4;
            color: white;
        }

        .modal-btn.secondary {
            background: #f5f5f5;
            color: #666;
        }

        .modal-btn:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìÖ Daily Routine & Mess Menu</h1>
            <div class="datetime" id="currentDate"></div>
            <div class="current-time" id="currentTime"></div>
            <div class="calendar-sync-section">
                <button class="google-btn" id="authorizeButton" style="display: none;">
                    üìÖ Connect Google Calendar
                </button>
                <button class="google-btn primary" id="exportButton" style="display: none;">
                    ‚¨ÜÔ∏è Export to Calendar
                </button>
                <button class="google-btn danger" id="signoutButton" style="display: none;">
                    üö™ Sign Out
                </button>
                <span class="sync-status" id="syncStatus"></span>
            </div>
        </div>

        <div class="content">
            <div class="loading" id="loading">Loading your schedule and menu...</div>
            <div id="mainContent" style="display: none;">
                <div class="section">
                    <h2><span class="icon">üìö</span>Today's Class Schedule</h2>
                    <div class="routine-grid" id="routineGrid"></div>
                </div>

                <div class="section">
                    <h2><span class="icon">üçΩÔ∏è</span>Today's Mess Menu</h2>
                    <div class="menu-grid" id="menuGrid"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="exportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì§ Export to Google Calendar</h2>
                <p>Choose what you'd like to export:</p>
            </div>
            <div class="modal-body">
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" id="exportRoutine" checked>
                        <span>üìö Class Schedule (Weekly recurring)</span>
                    </label>
                    <label>
                        <input type="checkbox" id="exportMenu" checked>
                        <span>üçΩÔ∏è Mess Menu (Weekly recurring)</span>
                    </label>
                </div>
                <p style="color: #666; font-size: 0.9em; margin-top: 15px;">
                    ‚ÑπÔ∏è Events will be created as recurring weekly events for the semester (16 weeks).
                </p>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="closeExportModal()">Cancel</button>
                <button class="modal-btn primary" onclick="confirmExport()">Export</button>
            </div>
        </div>
    </div>

    <script>
        class RoutineMenuApp {
            constructor() {
                this.routineData = null;
                this.menuData = null;
                this.currentDay = null;
                this.currentTime = null;
                this.init();
                this.createFloatingElements();
            }

            createFloatingElements() {
                const elements = ['üå∏', 'üåº', 'üçÄ', 'ü¶ã', '‚ú®', 'üåø', 'üå∫', 'üçÉ'];
                
                setInterval(() => {
                    const element = document.createElement('div');
                    element.className = 'floating-element';
                    element.innerHTML = elements[Math.floor(Math.random() * elements.length)];
                    element.style.left = Math.random() * 100 + 'vw';
                    element.style.fontSize = (Math.random() * 20 + 15) + 'px';
                    element.style.animationDuration = (Math.random() * 3 + 5) + 's';
                    
                    document.body.appendChild(element);
                    
                    setTimeout(() => {
                        element.remove();
                    }, 8000);
                }, 2000);
            }

            async init() {
                this.updateDateTime();
                setInterval(() => this.updateDateTime(), 1000);
                
                try {
                    await this.loadData();
                    this.renderContent();
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                } catch (error) {
                    this.showError('Failed to load data: ' + error.message);
                }
            }

            updateDateTime() {
                const now = new Date();
                const options = { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                };
                
                document.getElementById('currentDate').textContent = 
                    now.toLocaleDateString('en-US', options);
                
                document.getElementById('currentTime').textContent = 
                    now.toLocaleTimeString('en-US', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        second: '2-digit'
                    });

                this.currentDay = now.toLocaleDateString('en-US', { weekday: 'long' });
                this.currentTime = now.getHours();
            }

            async loadData() {
                try {
                    // Load routine data
                    const routineResponse = await fetch('routine.csv');
                    const routineText = await routineResponse.text();
                    this.routineData = this.parseCSV(routineText);

                    // Load menu data
                    const menuResponse = await fetch('menu.csv');
                    const menuText = await menuResponse.text();
                    this.menuData = this.parseCSV(menuText);
                } catch (error) {
                    throw new Error('Could not load CSV files. Make sure routine.csv and menu.csv are in the same directory.');
                }
            }

            parseCSV(text) {
                const lines = text.trim().split('\n');
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                const data = [];

                for (let i = 1; i < lines.length; i++) {
                    const values = this.parseCSVLine(lines[i]);
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] || '';
                    });
                    data.push(row);
                }

                return { headers, data };
            }

            parseCSVLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim().replace(/"/g, ''));
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                result.push(current.trim().replace(/"/g, ''));
                return result;
            }

            renderContent() {
                this.renderRoutine();
                this.renderMenu();
            }

            renderRoutine() {
                const routineGrid = document.getElementById('routineGrid');
                const todayRoutine = this.routineData.data.find(row => 
                    row.Day.toLowerCase() === this.currentDay.toLowerCase()
                );

                if (!todayRoutine) {
                    routineGrid.innerHTML = '<div class="error">No routine found for today.</div>';
                    return;
                }

                const timeSlots = [
                    { time: '9:00 - 10:00', hour: 9 },
                    { time: '10:00 - 11:00', hour: 10 },
                    { time: '11:00 - 12:00', hour: 11 },
                    { time: '12:00 - 1:00', hour: 12 },
                    { time: '1:00 - 2:00', hour: 13 },
                    { time: '2:00 - 3:00', hour: 14 },
                    { time: '3:00 - 4:00', hour: 15 },
                    { time: '4:00 - 5:00', hour: 16 }
                ];

                routineGrid.innerHTML = '';

                timeSlots.forEach(slot => {
                    const subject = todayRoutine[slot.time] || 'Free';
                    const isCurrent = this.currentTime === slot.hour;
                    
                    // Skip free slots - only show busy ones
                    if (subject.toLowerCase() === 'free') {
                        return;
                    }
                    
                    const slotDiv = document.createElement('div');
                    slotDiv.className = `time-slot ${isCurrent ? 'current' : ''}`;
                    
                    slotDiv.innerHTML = `
                        <h3>${slot.time}</h3>
                        <div>${subject}</div>
                    `;
                    
                    routineGrid.appendChild(slotDiv);
                });
            }

            renderMenu() {
                const menuGrid = document.getElementById('menuGrid');
                const todayMenu = this.menuData.data.find(row => 
                    row['Column 1'] && row['Column 1'].toLowerCase().includes('breakfast')
                );

                if (!todayMenu) {
                    menuGrid.innerHTML = '<div class="error">No menu found for today.</div>';
                    return;
                }

                const meals = [
                    { name: 'Breakfast', time: [7, 8, 9], icon: 'üåÖ' },
                    { name: 'Lunch', time: [12, 13, 14], icon: '‚òÄÔ∏è' },
                    { name: 'Snacks', time: [16, 17], icon: '‚òï' },
                    { name: 'Dinner', time: [19, 20, 21], icon: 'üåô' }
                ];

                menuGrid.innerHTML = '';

                // Find the data for each meal type
                meals.forEach(meal => {
                    const mealData = this.menuData.data.find(row => 
                        row['Column 1'] && row['Column 1'].toLowerCase() === meal.name.toLowerCase()
                    );

                    if (mealData) {
                        const isCurrent = meal.time.includes(this.currentTime);
                        const todayMealItems = mealData[this.currentDay] || 'No menu available';
                        
                        const mealDiv = document.createElement('div');
                        mealDiv.className = `meal-card ${isCurrent ? 'current-meal' : ''}`;
                        
                        mealDiv.innerHTML = `
                            <h3>${meal.icon} ${meal.name}</h3>
                            <div class="meal-items">${this.formatMealItems(todayMealItems)}</div>
                        `;
                        
                        menuGrid.appendChild(mealDiv);
                    }
                });
            }

            formatMealItems(items) {
                if (!items || items === 'No menu available') {
                    return '<em>üçΩÔ∏è No menu available</em>';
                }
                
                // Split by comma and format each item with cute emojis
                const foodEmojis = ['ü•ó', 'üçõ', 'üçú', 'ü•ò', 'üçù', 'ü•ô', 'üåÆ', 'üç≤', 'ü•û', 'üßÜ'];
                return items.split(',').map((item, index) => 
                    `${foodEmojis[index % foodEmojis.length]} ${item.trim()}`
                ).join('<br>');
            }

            showError(message) {
                document.getElementById('loading').innerHTML = `
                    <div class="error">${message}</div>
                `;
            }
        }

        // Google Calendar Integration
        class GoogleCalendarSync {
            constructor(routineApp) {
                this.routineApp = routineApp;
                this.isSignedIn = false;
                this.initClient();
            }

            initClient() {
                // Check if config is loaded
                if (typeof GOOGLE_CONFIG === 'undefined') {
                    console.warn('Google Calendar config not found. Please copy config.example.js to config.js and add your credentials.');
                    this.updateSigninStatus(false);
                    return;
                }

                gapi.load('client:auth2', () => {
                    gapi.client.init({
                        apiKey: GOOGLE_CONFIG.API_KEY,
                        clientId: GOOGLE_CONFIG.CLIENT_ID,
                        discoveryDocs: GOOGLE_CONFIG.DISCOVERY_DOCS,
                        scope: GOOGLE_CONFIG.SCOPES
                    }).then(() => {
                        // Listen for sign-in state changes
                        gapi.auth2.getAuthInstance().isSignedIn.listen((isSignedIn) => {
                            this.updateSigninStatus(isSignedIn);
                        });

                        // Handle initial sign-in state
                        this.updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
                    }, (error) => {
                        console.error('Error initializing Google API client:', error);
                        this.showStatus('Configuration error. Check console for details.', 'error');
                    });
                });
            }

            updateSigninStatus(isSignedIn) {
                this.isSignedIn = isSignedIn;
                const authorizeButton = document.getElementById('authorizeButton');
                const signoutButton = document.getElementById('signoutButton');
                const exportButton = document.getElementById('exportButton');

                if (isSignedIn) {
                    authorizeButton.style.display = 'none';
                    signoutButton.style.display = 'inline-flex';
                    exportButton.style.display = 'inline-flex';
                    this.showStatus('‚úÖ Connected to Google Calendar', 'success');
                } else {
                    authorizeButton.style.display = 'inline-flex';
                    signoutButton.style.display = 'none';
                    exportButton.style.display = 'none';
                    this.showStatus('');
                }
            }

            handleAuthClick() {
                if (typeof gapi === 'undefined' || !gapi.auth2) {
                    this.showStatus('Google Calendar not configured', 'error');
                    return;
                }
                gapi.auth2.getAuthInstance().signIn();
            }

            handleSignoutClick() {
                gapi.auth2.getAuthInstance().signOut();
            }

            showStatus(message, type = '') {
                const statusElement = document.getElementById('syncStatus');
                statusElement.textContent = message;
                statusElement.className = 'sync-status ' + type;
            }

            async exportToCalendar(includeRoutine, includeMenu) {
                if (!this.isSignedIn) {
                    this.showStatus('Please sign in first', 'error');
                    return;
                }

                this.showStatus('‚è≥ Exporting...', '');
                
                try {
                    let eventsCreated = 0;

                    if (includeRoutine) {
                        eventsCreated += await this.exportRoutine();
                    }

                    if (includeMenu) {
                        eventsCreated += await this.exportMenu();
                    }

                    this.showStatus(`‚úÖ Exported ${eventsCreated} events!`, 'success');
                    
                    setTimeout(() => {
                        this.showStatus('‚úÖ Connected to Google Calendar', 'success');
                    }, 5000);
                } catch (error) {
                    console.error('Export error:', error);
                    this.showStatus('‚ùå Export failed: ' + error.message, 'error');
                }
            }

            async exportRoutine() {
                const routineData = this.routineApp.routineData;
                if (!routineData || !routineData.data) {
                    throw new Error('No routine data available');
                }

                const config = typeof CALENDAR_SETTINGS !== 'undefined' ? CALENDAR_SETTINGS : {
                    TIMEZONE: 'Asia/Kolkata',
                    COLORS: { CLASS: '9' },
                    REMINDERS: { CLASS: [15] },
                    RECURRENCE: { ENABLED: true, WEEKS: 16 }
                };

                let eventsCreated = 0;
                const batch = gapi.client.newBatch();

                // Get the next Monday as start date
                const nextMonday = this.getNextMonday();

                // Process each day's routine
                for (const dayData of routineData.data) {
                    const dayName = dayData.Day;
                    const dayOffset = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'].indexOf(dayName);
                    
                    if (dayOffset === -1) continue;

                    // Get the date for this day
                    const eventDate = new Date(nextMonday);
                    eventDate.setDate(eventDate.getDate() + dayOffset);

                    // Time slots from 9 AM to 5 PM
                    const timeSlots = [
                        { time: '9:00 - 10:00', start: '09:00', end: '10:00' },
                        { time: '10:00 - 11:00', start: '10:00', end: '11:00' },
                        { time: '11:00 - 12:00', start: '11:00', end: '12:00' },
                        { time: '12:00 - 1:00', start: '12:00', end: '13:00' },
                        { time: '1:00 - 2:00', start: '13:00', end: '14:00' },
                        { time: '2:00 - 3:00', start: '14:00', end: '15:00' },
                        { time: '3:00 - 4:00', start: '15:00', end: '16:00' },
                        { time: '4:00 - 5:00', start: '16:00', end: '17:00' }
                    ];

                    for (const slot of timeSlots) {
                        const subject = dayData[slot.time];
                        
                        // Skip free slots and lunch
                        if (!subject || subject.toLowerCase() === 'free' || subject.toLowerCase() === 'lunch') {
                            continue;
                        }

                        const startDateTime = this.formatDateTime(eventDate, slot.start);
                        const endDateTime = this.formatDateTime(eventDate, slot.end);

                        const event = {
                            'summary': `üìö ${subject}`,
                            'description': `Class: ${subject}\nTime: ${slot.time}`,
                            'start': {
                                'dateTime': startDateTime,
                                'timeZone': config.TIMEZONE
                            },
                            'end': {
                                'dateTime': endDateTime,
                                'timeZone': config.TIMEZONE
                            },
                            'colorId': config.COLORS.CLASS,
                            'reminders': {
                                'useDefault': false,
                                'overrides': config.REMINDERS.CLASS.map(min => ({ 'method': 'popup', 'minutes': min }))
                            }
                        };

                        // Add recurrence if enabled
                        if (config.RECURRENCE.ENABLED) {
                            event.recurrence = [`RRULE:FREQ=WEEKLY;COUNT=${config.RECURRENCE.WEEKS}`];
                        }

                        batch.add(
                            gapi.client.calendar.events.insert({
                                'calendarId': 'primary',
                                'resource': event
                            })
                        );
                        eventsCreated++;
                    }
                }

                if (eventsCreated > 0) {
                    await batch.then((response) => {
                        console.log('Routine events created:', response);
                    });
                }

                return eventsCreated;
            }

            async exportMenu() {
                const menuData = this.routineApp.menuData;
                if (!menuData || !menuData.data) {
                    throw new Error('No menu data available');
                }

                const config = typeof CALENDAR_SETTINGS !== 'undefined' ? CALENDAR_SETTINGS : {
                    TIMEZONE: 'Asia/Kolkata',
                    COLORS: { MEAL: '6', SNACK: '5' },
                    REMINDERS: { MEAL: [30], SNACK: [15] },
                    RECURRENCE: { ENABLED: true, WEEKS: 16 }
                };

                let eventsCreated = 0;
                const batch = gapi.client.newBatch();

                // Get the next Monday as start date
                const nextMonday = this.getNextMonday();

                // Meal times
                const mealTimes = {
                    'Breakfast': { start: '08:00', end: '09:00', icon: 'üåÖ', color: config.COLORS.MEAL },
                    'Lunch': { start: '13:00', end: '14:00', icon: '‚òÄÔ∏è', color: config.COLORS.MEAL },
                    'Snacks': { start: '16:30', end: '17:00', icon: '‚òï', color: config.COLORS.SNACK },
                    'Dinner': { start: '20:00', end: '21:00', icon: 'üåô', color: config.COLORS.MEAL }
                };

                // Days of the week
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

                for (const mealRow of menuData.data) {
                    const mealType = mealRow['Column 1'];
                    if (!mealType || !mealTimes[mealType]) continue;

                    const mealInfo = mealTimes[mealType];

                    for (const day of days) {
                        const menuItems = mealRow[day];
                        if (!menuItems) continue;

                        const dayOffset = days.indexOf(day);
                        const eventDate = new Date(nextMonday);
                        // Adjust for Sunday being at the beginning
                        eventDate.setDate(eventDate.getDate() + dayOffset - 1);
                        if (dayOffset === 0) { // Sunday
                            eventDate.setDate(eventDate.getDate() + 6);
                        }

                        const startDateTime = this.formatDateTime(eventDate, mealInfo.start);
                        const endDateTime = this.formatDateTime(eventDate, mealInfo.end);

                        // Truncate menu items if too long
                        const description = menuItems.length > 500 ? menuItems.substring(0, 497) + '...' : menuItems;

                        const event = {
                            'summary': `${mealInfo.icon} ${mealType}`,
                            'description': description,
                            'start': {
                                'dateTime': startDateTime,
                                'timeZone': config.TIMEZONE
                            },
                            'end': {
                                'dateTime': endDateTime,
                                'timeZone': config.TIMEZONE
                            },
                            'colorId': mealInfo.color,
                            'reminders': {
                                'useDefault': false,
                                'overrides': (mealType === 'Snacks' ? config.REMINDERS.SNACK : config.REMINDERS.MEAL).map(min => ({ 'method': 'popup', 'minutes': min }))
                            }
                        };

                        // Add recurrence if enabled
                        if (config.RECURRENCE.ENABLED) {
                            event.recurrence = [`RRULE:FREQ=WEEKLY;COUNT=${config.RECURRENCE.WEEKS}`];
                        }

                        batch.add(
                            gapi.client.calendar.events.insert({
                                'calendarId': 'primary',
                                'resource': event
                            })
                        );
                        eventsCreated++;
                    }
                }

                if (eventsCreated > 0) {
                    await batch.then((response) => {
                        console.log('Menu events created:', response);
                    });
                }

                return eventsCreated;
            }

            getNextMonday() {
                const today = new Date();
                const day = today.getDay();
                const diff = day === 0 ? 1 : 8 - day; // If Sunday, next day is Monday; otherwise calculate
                const nextMonday = new Date(today);
                nextMonday.setDate(today.getDate() + diff);
                nextMonday.setHours(0, 0, 0, 0);
                return nextMonday;
            }

            formatDateTime(date, time) {
                const [hours, minutes] = time.split(':');
                const dateTime = new Date(date);
                dateTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                return dateTime.toISOString();
            }
        }

        // Modal functions
        function openExportModal() {
            document.getElementById('exportModal').style.display = 'block';
        }

        function closeExportModal() {
            document.getElementById('exportModal').style.display = 'none';
        }

        function confirmExport() {
            const includeRoutine = document.getElementById('exportRoutine').checked;
            const includeMenu = document.getElementById('exportMenu').checked;
            
            if (!includeRoutine && !includeMenu) {
                alert('Please select at least one option to export.');
                return;
            }
            
            closeExportModal();
            window.calendarSync.exportToCalendar(includeRoutine, includeMenu);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('exportModal');
            if (event.target === modal) {
                closeExportModal();
            }
        }

        // Initialize the app when the page loads
        let routineApp;
        let calendarSync;
        
        document.addEventListener('DOMContentLoaded', () => {
            routineApp = new RoutineMenuApp();
            
            // Initialize Google Calendar after a short delay to ensure app data is loaded
            setTimeout(() => {
                calendarSync = new GoogleCalendarSync(routineApp);
                
                // Set up button event listeners
                document.getElementById('authorizeButton').addEventListener('click', () => {
                    calendarSync.handleAuthClick();
                });
                
                document.getElementById('signoutButton').addEventListener('click', () => {
                    calendarSync.handleSignoutClick();
                });
                
                document.getElementById('exportButton').addEventListener('click', () => {
                    openExportModal();
                });
            }, 1000);
        });
    </script>
</body>
</html>
